<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Amulet</title>
    <link rel="stylesheet" href="codemirror-4.9.css">
    <link rel="stylesheet" href="style.css">
    <style type="text/css">
#status-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 1000;
}

#status {
    position: absolute;
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    left: 10px;
    top: 10px;
}
    </style>
  </head>
  <body>

    <div id="status-overlay">
        <div id="status">Loading...</div>
    </div>

    <div id="toolbar">
      <!--
      <span><input type="checkbox" id="resize">Resize canvas</span>
      <span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
      <span><input type="button" value="Fullscreen" onclick="Module.requestFullScreen(document.getElementById('pointerLock').checked, 
                                                                                document.getElementById('resize').checked)">
      </span>
      -->
      <button id="refresh">Refresh</button>
    </div>
    <div id="left-panel">
        <div id="editor-panel">
            <textarea id="editor"></textarea>
        </div>
    </div>
    <div id="vsplitter">
    </div>
    <div id="right-panel">
        <div id="canvas-panel">
            <!-- see init_canvas function -->
        </div>
        <div id="hsplitter">
        </div>
        <div id="output-panel">
            <textarea id="output" rows="8"></textarea>
        </div>
    </div>

    <script type='text/javascript'>
var editor;
var status_timer;

function init_controls() {
    $("#refresh").click(function() {
        var code = editor.getDoc().getValue();
        Module.ccall('am_emscripten_run', null, ['string'], [code]);
    });
}

function init_editor() {
    editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: {
            name: "lua",
            //specials: ["am.create_window"],
        },
        theme: "amulet",
        lineNumbers: true,
        indentUnit: 4,
        indentWithTabs: false,
        smartIndent: false,
        //extraKeys: {"Tab": "indentMore", "Shift-Tab": "indentLess"}, 
        electricChars: false,
    });

    // load example script
    $.get("example.lua", function(data) {
        editor.getDoc().setValue(data);
    }, "text");
}

function resize_canvas() {
    var canvas_panel = $("#canvas-panel");
    var canvas = document.getElementById("canvas");
    var w = canvas_panel.outerWidth();
    var h = canvas_panel.outerHeight();
    canvas.width = w;
    canvas.height = h;
    Module.ccall('am_emscripten_resize', null, ['number', 'number'], [w, h]);
}

function init_resize_handler() {
    $(window).resize(function() {
        resize_canvas();
    });
}

function init_canvas() {
    var canvas_panel = $("#canvas-panel");
    var width = canvas_panel.outerWidth();
    var height = canvas_panel.outerHeight();
    $("#canvas-panel").html('<canvas id="canvas" width="' + width + '" height="' + height + '" oncontextmenu="event.preventDefault()"></canvas>');
    var canvas = document.getElementById("canvas");
    // Pop up an alert when webgl context is lost.
    // TODO: handle webgl context restore event.
    // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
    canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);
    init_resize_handler();
    Module.canvas = canvas;
}

function init_vsplitter() {
    var dragging = false;
    $("#vsplitter").on("mousedown", function(evt) {
        if (evt.which == 1 && !dragging) {
            var start_page_x = evt.pageX;
            var splitter = $(this);
            var left = $(this).prev();
            var right = $(this).next();
            var splitter_width = parseInt(splitter.css("width").replace("px", ""));
            var start_splitter_left = parseInt(splitter.css("left").replace("px", ""));
            var start_right_width = parseInt(right.css("width").replace("px", ""));

            function m_move(evt) {
                var delta_x = evt.pageX - start_page_x;
                var l = start_splitter_left + delta_x;
                if (l < 0) {
                    l = 0;
                } else if (l > start_splitter_left + start_right_width) {
                    l = start_splitter_left + start_right_width;
                }
                left.css("width", l);
                splitter.css("left", l);
                right.css("left", l + splitter_width);
                resize_canvas();
                return false;
            }
            function m_up(evt) {
                $(document).off("mousemove", m_move);
                $(document).off("mouseup", m_up);
                dragging = false;
            }
            $(document).on("mousemove", m_move).on("mouseup", m_up);
            dragging = true;
            return false;
        }
    });
}

function init_hsplitter() {
    var dragging = false;
    $("#hsplitter").on("mousedown", function(evt) {
        if (evt.which == 1 && !dragging) {
            var start_page_y = evt.pageY;
            var splitter = $(this);
            var above = $(this).prev();
            var below = $(this).next();
            var splitter_height = parseInt(splitter.css("height").replace("px", ""));
            var start_splitter_bottom = parseInt(splitter.css("bottom").replace("px", ""));
            var start_below_height = parseInt(below.css("height").replace("px", ""));
            var start_above_bottom = parseInt(above.css("bottom").replace("px", ""));
            var start_above_height = parseInt(above.css("height").replace("px", ""));

            function m_move(evt) {
                var delta_y = start_page_y - evt.pageY;
                if (start_above_height - delta_y < 0) {
                    splitter.css("bottom", start_above_height + start_below_height);
                    above.css("bottom", start_above_height + start_below_height + splitter_height);
                    below.css("height", start_above_height + start_below_height);
                } else if (start_below_height + delta_y < 0) {
                    splitter.css("bottom", 0);
                    above.css("bottom", splitter_height);
                    below.css("height", 0);
                } else {
                    splitter.css("bottom", start_splitter_bottom + delta_y);
                    above.css("bottom", start_above_bottom + delta_y);
                    below.css("height", start_below_height + delta_y);
                }
                resize_canvas();
                return false;
            }
            function m_up(evt) {
                $(document).off("mousemove", m_move);
                $(document).off("mouseup", m_up);
                dragging = false;
            }
            $(document).on("mousemove", m_move).on("mouseup", m_up);
            dragging = true;
            return false;
        }
    });
}

function set_status_text(text) {
    $("#status").text(text);
}

var dots = 3;
function animate_loading_status() {
    dots = (dots + 1) % 10;
    var text = "Loading";
    for (var i = 0; i < dots; i++) {
        text += ".";
    }
    set_status_text(text);
}

status_timer = setInterval(animate_loading_status, 500);
function clear_status_timer() {
    clearInterval(status_timer);
    status_timer = null;
}

function remove_status_overlay() {
    $("#status-overlay").hide();
    clear_status_timer();
}

function setup() {
    try {
        init_controls();
        init_editor();
        init_vsplitter();
        init_hsplitter();
        init_canvas();
        remove_status_overlay();
    } catch (e) {
        clear_status_timer();
        set_status_text('Something went wrong. See JavaScript console for details.');
        throw e;
    }
}

//------------------------------------------------------------------------

var Module = {
  preRun: [setup],
  postRun: [],
  print: (function() {
    var element = document.getElementById('output');
    if (element) element.value = ''; // clear browser cache
    return function(text) {
      text = Array.prototype.slice.call(arguments).join(' ');
      // These replacements are necessary if you render to raw HTML
      //text = text.replace(/&/g, "&amp;");
      //text = text.replace(/</g, "&lt;");
      //text = text.replace(/>/g, "&gt;");
      //text = text.replace('\n', '<br>', 'g');
      console.log(text);
      if (element) {
        element.value += text + "\n";
        element.scrollTop = element.scrollHeight; // focus on bottom
      }
    };
  })(),
  printErr: function(text) {
    text = Array.prototype.slice.call(arguments).join(' ');
    if (0) { // XXX disabled for safety typeof dump == 'function') {
      dump(text + '\n'); // fast, straight to the real console
    } else {
      console.error(text);
    }
  },
  canvas: null, // initialized in init_canvas
  keyboardListeningElement: document.getElementById('canvas-panel'),
  setStatus: function(text) {
      console.log(text);
  },
  totalDependencies: 0,
  monitorRunDependencies: function(left) {
    this.totalDependencies = Math.max(this.totalDependencies, left);
    Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
  }
};
Module.setStatus('Downloading...');
window.onerror = function(event) {
  // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
  set_status_text('Something went wrong. See JavaScript console for details.');
  Module.setStatus = function(text) {
    if (text) Module.printErr('[post-exception status] ' + text);
  };
};


    </script>
    <script src="codemirror-4.9-compressed.js"></script>
    <script src="jquery-2.1.3.min.js" type="text/javascript"></script>
    <script async type="text/javascript" src="amulet.js"></script>
  </body>
</html>
