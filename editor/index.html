<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Amulet</title>
    <link rel="stylesheet" href="codemirror-4.8.css">
    <link rel="stylesheet" href="style.css">
    <script src="codemirror-4.8-compressed.js"></script>
    <script src="jquery-2.1.3.min.js" type="text/javascript"></script>
    <script type="text/javascript">

var editor;
var status_timer;

function init_controls() {
    $("#refresh").click(function() {
        var code = editor.getDoc().getValue();
        Module.ccall('am_restart_with_script', null, ['string'], [code]);
    });
}

function init_editor() {
    editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        lineNumbers: true,
        mode: "lua",
        indentUnit: 4,
        extraKeys: {"Tab": "indentMore", "Shift-Tab": "indentLess"}, 
        electricChars: true,
    });

    // load example script
    $.get("example.lua", function(data) {
        editor.getDoc().setValue(data);
    }, "text");
}

function init_vsplitter() {
    var dragging = false;
    $("#vsplitter").on("mousedown", function(evt) {
        if (evt.which == 1 && !dragging) {
            var start_page_x = evt.pageX;
            var splitter = $(this);
            var left = $(this).prev();
            var right = $(this).next();
            var splitter_width = parseInt(splitter.css("width").replace("px", ""));
            var start_splitter_left = parseInt(splitter.css("left").replace("px", ""));
            var start_right_width = parseInt(right.css("width").replace("px", ""));

            function m_move(evt) {
                var delta_x = evt.pageX - start_page_x;
                var l = start_splitter_left + delta_x;
                if (l < 0) {
                    l = 0;
                } else if (l > start_splitter_left + start_right_width) {
                    l = start_splitter_left + start_right_width;
                }
                left.css("width", l);
                splitter.css("left", l);
                right.css("left", l + splitter_width);
                return false;
            }
            function m_up(evt) {
                $(document).off("mousemove", m_move);
                $(document).off("mouseup", m_up);
                dragging = false;
            }
            $(document).on("mousemove", m_move).on("mouseup", m_up);
            dragging = true;
            return false;
        }
    });
}

function init_hsplitter() {
    var dragging = false;
    $("#hsplitter").on("mousedown", function(evt) {
        if (evt.which == 1 && !dragging) {
            var start_page_y = evt.pageY;
            var splitter = $(this);
            var above = $(this).prev();
            var below = $(this).next();
            var splitter_height = parseInt(splitter.css("height").replace("px", ""));
            var start_splitter_bottom = parseInt(splitter.css("bottom").replace("px", ""));
            var start_below_height = parseInt(below.css("height").replace("px", ""));
            var start_above_bottom = parseInt(above.css("bottom").replace("px", ""));
            var start_above_height = parseInt(above.css("height").replace("px", ""));

            function m_move(evt) {
                var delta_y = start_page_y - evt.pageY;
                if (start_above_height - delta_y < 0) {
                    splitter.css("bottom", start_above_height + start_below_height);
                    above.css("bottom", start_above_height + start_below_height + splitter_height);
                    below.css("height", start_above_height + start_below_height);
                } else if (start_below_height + delta_y < 0) {
                    splitter.css("bottom", 0);
                    above.css("bottom", splitter_height);
                    below.css("height", 0);
                } else {
                    splitter.css("bottom", start_splitter_bottom + delta_y);
                    above.css("bottom", start_above_bottom + delta_y);
                    below.css("height", start_below_height + delta_y);
                }
                return false;
            }
            function m_up(evt) {
                $(document).off("mousemove", m_move);
                $(document).off("mouseup", m_up);
                dragging = false;
            }
            $(document).on("mousemove", m_move).on("mouseup", m_up);
            dragging = true;
            return false;
        }
    });
}

var dots = 3;
function animate_status() {
    dots = (dots + 1) % 10;
    var text = "Loading";
    for (var i = 0; i < dots; i++) {
        text += ".";
    }
    $("#status").text(text);
}

function setup() {
    init_controls();
    init_editor();
    init_vsplitter();
    init_hsplitter();
    $("#status-overlay").hide();
    clearInterval(status_timer);
    status_timer = null;
}

    </script>
  </head>
  <body>


    
    <div id="top-panel">
      <!--
      <span><input type="checkbox" id="resize">Resize canvas</span>
      <span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
      <span><input type="button" value="Fullscreen" onclick="Module.requestFullScreen(document.getElementById('pointerLock').checked, 
                                                                                document.getElementById('resize').checked)">
      </span>
      -->
      <button id="refresh">Refresh</button>
    </div>
    <div id="left-panel">
        <div id="editor-panel">
            <textarea id="editor"></textarea>
        </div>
    </div>
    <div id="vsplitter">
    </div>
    <div id="right-panel">
        <div id="canvas-panel">
            <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
        </div>
        <div id="hsplitter">
        </div>
        <div id="output-panel">
            <textarea id="output" rows="8"></textarea>
        </div>
    </div>

    <div id="status-overlay">
        <div id="status">Loading...</div>
    </div>

    <script type='text/javascript'>

var statusElement = document.getElementById('status');
status_timer = setInterval(animate_status, 500);

var Module = {
  preRun: [setup],
  postRun: [],
  print: (function() {
    var element = document.getElementById('output');
    if (element) element.value = ''; // clear browser cache
    return function(text) {
      text = Array.prototype.slice.call(arguments).join(' ');
      // These replacements are necessary if you render to raw HTML
      //text = text.replace(/&/g, "&amp;");
      //text = text.replace(/</g, "&lt;");
      //text = text.replace(/>/g, "&gt;");
      //text = text.replace('\n', '<br>', 'g');
      console.log(text);
      if (element) {
        element.value += text + "\n";
        element.scrollTop = element.scrollHeight; // focus on bottom
      }
    };
  })(),
  printErr: function(text) {
    text = Array.prototype.slice.call(arguments).join(' ');
    if (0) { // XXX disabled for safety typeof dump == 'function') {
      dump(text + '\n'); // fast, straight to the real console
    } else {
      console.error(text);
    }
  },
  canvas: (function() {
    var canvas = document.getElementById('canvas');

    // As a default initial behavior, pop up an alert when webgl context is lost. To make your
    // application robust, you may want to override this behavior before shipping!
    // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
    canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

    return canvas;
  })(),
  keyboardListeningElement: document.getElementById('canvas'),
  setStatus: function(text) {
    //statusElement.innerHTML = text;
  },
  totalDependencies: 0,
  monitorRunDependencies: function(left) {
    this.totalDependencies = Math.max(this.totalDependencies, left);
    Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
  }
};
Module.setStatus('Downloading...');
window.onerror = function(event) {
  // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
  Module.setStatus('Exception thrown, see JavaScript console');
  Module.setStatus = function(text) {
    if (text) Module.printErr('[post-exception status] ' + text);
  };
};


    </script>
    <script async type="text/javascript" src="amulet.js"></script>
  </body>
</html>
