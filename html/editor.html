<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Amulet</title>
    <link rel="stylesheet" href="codemirror-4.9.css">
    <link rel="stylesheet" href="editor.css">
    <style type="text/css">
    </style>
  </head>
  <body>
    <div id="top-panel">
        <span class="title">Amulet</span>
        <a id="run">Run</a>
        <a id="pause-resume">Pause</a>
    </div>
    <div id="left-panel">
        <div id="editor-panel">
            <textarea id="editor"></textarea>
        </div>
    </div>
    <div id="vsplitter">
    </div>
    <div id="right-panel">
        <div id="player-panel">
            <iframe id="player-frame" src="player.html"></iframe>
        </div>
        <div id="hsplitter">
        </div>
        <div id="output-panel">
        </div>
    </div>

    <script src="codemirror-4.9-compressed.js"></script>
    <script src="jquery-2.1.3.min.js" type="text/javascript"></script>
    <script type='text/javascript'>

var editor;

var is_paused = false;
var was_error = false;

function init_controls() {
    $("#run").click(function() {
        var code = editor.getDoc().getValue();
        clear_output();
        log_start();
        was_error = false;
        is_paused = false;
        $("#pause-resume").text("Pause").removeClass("disabled");
        var win = document.getElementById("player-frame").contentWindow;
        win.postMessage({run: code}, "*");
    });
    $("#pause-resume").click(function() {
        if (was_error) return;
        var win = document.getElementById("player-frame").contentWindow;
        if (is_paused) {
            win.postMessage({resume: true}, "*");
            $("#pause-resume").text("Pause");
        } else {
            win.postMessage({pause: true}, "*");
            $("#pause-resume").text("Resume");
        }
        is_paused = !is_paused;
    });
}

function init_editor() {
    editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: {
            name: "lua",
        },
        theme: "amulet",
        lineNumbers: true,
        indentUnit: 4,
        indentWithTabs: false,
        smartIndent: false,
        extraKeys: {"Tab": "indentMore", "Shift-Tab": "indentLess"}, 
        electricChars: false,
    });

    // load example script
    $.get("example.lua", function(data) {
        editor.getDoc().setValue(data);
    }, "text");
}

function get_storage_object(key) {
    var item = localStorage.getItem(key);
    if (!item) {
        return null;
    } else {
        //console.log(item);
        return JSON.parse(item);
    }
}

function set_storate_object(key, obj) {
    localStorage.setItem(key, JSON.stringify(obj));
}

function init_layout() {
    var layout = get_storage_object("layout");
    if (!layout) {
        layout = {};
    }
    if (!layout.left_panel_width) {
        var page_width = $("body").outerWidth();
        var left_panel_width = Math.floor(page_width / 2);
        layout.left_panel_width = left_panel_width;
    }
    if (!layout.output_panel_height) {
        layout.output_panel_height = 200;
    }
    //console.log(JSON.stringify(layout));
    set_storate_object("layout", layout);

    var splitter_width = $("#vsplitter").outerWidth();
    var splitter_height = $("#hsplitter").outerHeight();
    var right_panel_left = layout.left_panel_width + splitter_width;

    $("#left-panel").css("width", layout.left_panel_width);
    $("#vsplitter").css("left", layout.left_panel_width);
    $("#right-panel").css("left", layout.left_panel_width + splitter_width);

    //console.log(layout.output_panel_height + splitter_height);
    $("#player-panel").css("bottom", layout.output_panel_height + splitter_height);
    $("#hsplitter").css("bottom", layout.output_panel_height);
    $("#output-panel").css("height", layout.output_panel_height);
}

function save_layout() {
    layout = {
        left_panel_width: $("#left-panel").outerWidth(),
        output_panel_height: $("#output-panel").outerHeight()
    };
    set_storate_object("layout", layout);
}

function init_vsplitter() {
    var dragging = false;
    $("#vsplitter").on("mousedown", function(evt) {
        if (evt.which == 1 && !dragging) {
            $("#player-frame").hide();
            var start_page_x = evt.pageX;
            var splitter = $(this);
            var left = $(this).prev();
            var right = $(this).next();
            var splitter_width = parseInt(splitter.css("width").replace("px", ""));
            var start_splitter_left = parseInt(splitter.css("left").replace("px", ""));
            var start_right_width = parseInt(right.css("width").replace("px", ""));

            function m_move(evt) {
                var delta_x = evt.pageX - start_page_x;
                var l = start_splitter_left + delta_x;
                if (l < 0) {
                    l = 0;
                } else if (l > start_splitter_left + start_right_width) {
                    l = start_splitter_left + start_right_width;
                }
                left.css("width", l);
                splitter.css("left", l);
                right.css("left", l + splitter_width);
                return false;
            }
            function m_up(evt) {
                $(document).off("mousemove", m_move);
                $(document).off("mouseup", m_up);
                $("#player-frame").show();
                //resize_player();
                save_layout();
                dragging = false;
            }
            $(document).on("mousemove", m_move).on("mouseup", m_up);
            dragging = true;
            return false;
        }
    });
}

function init_hsplitter() {
    var dragging = false;
    $("#hsplitter").on("mousedown", function(evt) {
        if (evt.which == 1 && !dragging) {
            $("#player-frame").hide();
            var start_page_y = evt.pageY;
            var splitter = $(this);
            var above = $(this).prev();
            var below = $(this).next();
            var splitter_height = parseInt(splitter.css("height").replace("px", ""));
            var start_splitter_bottom = parseInt(splitter.css("bottom").replace("px", ""));
            var start_below_height = parseInt(below.css("height").replace("px", ""));
            var start_above_bottom = parseInt(above.css("bottom").replace("px", ""));
            var start_above_height = parseInt(above.css("height").replace("px", ""));

            function m_move(evt) {
                var delta_y = start_page_y - evt.pageY;
                if (start_above_height - delta_y < 0) {
                    splitter.css("bottom", start_above_height + start_below_height);
                    above.css("bottom", start_above_height + start_below_height + splitter_height);
                    below.css("height", start_above_height + start_below_height);
                } else if (start_below_height + delta_y < 0) {
                    splitter.css("bottom", 0);
                    above.css("bottom", splitter_height);
                    below.css("height", 0);
                } else {
                    splitter.css("bottom", start_splitter_bottom + delta_y);
                    above.css("bottom", start_above_bottom + delta_y);
                    below.css("height", start_below_height + delta_y);
                }
                return false;
            }
            function m_up(evt) {
                $(document).off("mousemove", m_move);
                $(document).off("mouseup", m_up);
                $("#player-frame").show();
                //resize_player();
                save_layout();
                dragging = false;
            }
            $(document).on("mousemove", m_move).on("mouseup", m_up);
            dragging = true;
            return false;
        }
    });
}

function highlight_error(line) {
    editor.focus();
    editor.getDoc().setCursor(line-1, 0);
    var n = 2;
    while (n > 0) {
        setTimeout(function() {
            editor.getDoc().addLineClass(line-1, "background", "error-highlight");
        }, (n-1)*400);
        setTimeout(function() {
            editor.getDoc().removeLineClass(line-1, "background", "error-highlight");
        }, (n-1)*400+200);
        n--;
    }
}

var max_output_items = 100;
var output_items = [];
function log_output(text, cls) {
    var panel = document.getElementById("output-panel");

    text = text.replace(/&/g, "&amp;");
    text = text.replace(/</g, "&lt;");
    text = text.replace(/>/g, "&gt;");
    text = text.replace('\n', '<br>', 'g');
    text = text.replace(/(main\.lua):([0-9]+)/g, '<a class="error-link" onclick="window.highlight_error($2); return false;">$1:$2</a>');
    if (!cls) cls = "";
    output_items.push('<div class="output-item ' + cls + '">' + text + '</div>');

    while (output_items.length > max_output_items) {
        output_items.splice(0, 1);
    }
    panel.innerHTML = output_items.join("\n");
    panel.scrollTop = panel.scrollHeight; // follow bottom
}

function log_start() {
    log_output("Running...", "running");
}

function clear_output() {
    output_items = [];
    document.getElementById("output-panel").innerHTML = "";
}

function set_message_handler() {
    window.addEventListener("message", function(event) {
        if (event.data == "ERROR") {
            was_error = true;
            $("#pause-resume").addClass("disabled");
        } else {
            log_output(event.data);
        }
    }, false);
}
set_message_handler();

function resize_player() {
    var player = document.getElementById("player-frame");
    var player_parent = $("#player-frame").parent();
    var w = player_parent.outerWidth();
    var h = player_parent.outerHeight();
    player.width = w;
    player.height = h;
    log_output("resize_player called " + w + "x" + h);
}

function setup() {
    init_controls();
    init_editor();
    init_layout();
    init_vsplitter();
    init_hsplitter();
}

$(setup);
    </script>
  </body>
</html>
