<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title id="title">Amulet</title>
    <script src="jquery-2.1.3.min.js" type="text/javascript"></script>
    <style type="text/css">
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Verdana, Arial, Helvetica, sans-serif;
    font-size: 15px;
    overflow-x: hidden;
    overflow-y: hidden;
} 
#status-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 1000;
}
#status-positioner {
    position: absolute;
    left: 50%;
    bottom: 20%;
}
#status-box {
    width: 400px;
    height: 30px;
    margin-left: -200px;
    border: 2px solid #fff;
    padding: 2px;
}
#status-bar {
    width: 1%;
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #fff;
}
#canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
#video {
    display: none;
}
    </style>
  </head>
  <body>
    <video id="video" autoplay></video>
    <div id="status-overlay">
        <div id="status-positioner">
            <div id="status-box">
                <div id="status-bar"></div>
            </div>
        </div>
    </div>
    <canvas id="canvas" width="100" height="100"></canvas>

    <script type='text/javascript'>
var status_timer;

var havePointerLock = 'pointerLockElement' in document ||
    'mozPointerLockElement' in document ||
    'webkitPointerLockElement' in document;

navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;

window.amulet = {};

function run(script) {
    $.get(script, function(data) {
        Module.ccall('am_emscripten_run', null, ['string'], [data]);
    }, "text");
}

function init_canvas() {
    var canvas = document.getElementById("canvas");
    // Pop up an alert when webgl context is lost.
    // TODO: handle webgl context restore event.
    // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
    canvas.addEventListener("webglcontextlost", function(e) {
        alert('WebGL context lost. You will need to reload the page or, failing that, restart your browser).');
        e.preventDefault();
    }, false);
    if (havePointerLock) {
        $(canvas).click(function() {
            if (window.amulet.pointer_lock_requested) {
                canvas.requestPointerLock =
                    canvas.requestPointerLock ||
                    canvas.mozRequestPointerLock ||
                    canvas.webkitRequestPointerLock;
                canvas.requestPointerLock();
            }
        });
    }
}

function set_status_text(text) {
    $("#status").text(text);
}

function set_progress(perc) {
    document.getElementById("status-bar").style.width = perc + "%";
}
var perc = 1;
var delta = 0.65;
var phase1_limit = 33;
function phase1() {
    perc = Math.min(phase1_limit, perc + delta);
    delta = delta * 0.98;
    set_progress(perc);
    console.log(perc);
}
function phase2() {
    var prog = window.amulet.load_progress || 0;
    set_progress(prog * ((100-phase1_limit)/100) + phase1_limit);
}
var phase = phase1;
function animate_loading_status() {
    if (phase === phase1 && document.readyState == "complete") {
        phase = phase2;
        set_progress(phase1_limit);
    }
    phase();
}

status_timer = setInterval(animate_loading_status, 100);
function clear_status_timer() {
    clearInterval(status_timer);
    status_timer = null;
}

function remove_status_overlay() {
    $("#status-overlay").hide();
    clear_status_timer();
}

window.amulet.start = function() {
    try {
        init_canvas();
        remove_status_overlay();
    } catch (e) {
        clear_status_timer();
        set_status_text('Something went wrong. See JavaScript console for details.');
        throw e;
    }
}

function set_visibility_handler() {
    var hidden, visibilityChange; 
    if (typeof document.hidden !== "undefined") {
      hidden = "hidden";
      visibilityChange = "visibilitychange";
    } else if (typeof document.mozHidden !== "undefined") {
      hidden = "mozHidden";
      visibilityChange = "mozvisibilitychange";
    } else if (typeof document.msHidden !== "undefined") {
      hidden = "msHidden";
      visibilityChange = "msvisibilitychange";
    } else if (typeof document.webkitHidden !== "undefined") {
      hidden = "webkitHidden";
      visibilityChange = "webkitvisibilitychange";
    }
    document.addEventListener(visibilityChange, function(event) {
        window.amulet.window_hidden = document[hidden] ? 1 : 0;
        //console.log("hidden = " + window.amulet.window_hidden);
    }, false);
    window.amulet.window_hidden = 0;
}
set_visibility_handler();

var msg_source = null;
var msg_origin = null;
function set_message_handler() {
    window.addEventListener("message", function(event) {
        var cmd = event.data;
        if (cmd.run) {
            msg_source = event.source;
            msg_origin = event.origin;
            Module.ccall('am_emscripten_run', null, ['string'], [cmd.run]);
        } else if (cmd.pause) {
            Module.ccall('am_emscripten_pause', null, [], []);
        } else if (cmd.resume) {
            Module.ccall('am_emscripten_resume', null, [], []);
        }
    }, false);
}
set_message_handler();

//------------------------------------------------------------------------

var Module = {
  preRun: [],
  postRun: [],
  print: function(text) {
      console.log(text);
      if (msg_source) {
        msg_source.postMessage(text, msg_origin);
      }
  },
  printErr: function(text) {
    text = Array.prototype.slice.call(arguments).join(' ');
    console.error(text);
    if (msg_source) {
      msg_source.postMessage(text, msg_origin);
    }
  },
  canvas: document.getElementById("canvas"),
  keyboardListeningElement: document,
  setStatus: function(text) {
      console.log(text);
  },
  totalDependencies: 0,
  monitorRunDependencies: function(left) {
    this.totalDependencies = Math.max(this.totalDependencies, left);
    Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
  }
};
Module.setStatus('Downloading...');
window.onerror = function(event) {
  // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
  set_status_text('Something went wrong. See JavaScript console for details.');
  Module.setStatus = function(text) {
    if (text) Module.printErr('[post-exception status] ' + text);
  };
};
    </script>
    <script async type="text/javascript" src="amulet.js"></script>
  </body>
</html>
